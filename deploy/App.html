<!DOCTYPE html>
<html>
<head>
    <title>DashB</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this,app.queryIterations()},queryIterations:function(){var today=new Date,lastYear=new Date;lastYear.setDate(today.getDate()-365);var todayISO=Rally.util.DateTime.toIsoString(today,!1),lastYearISO=Rally.util.DateTime.toIsoString(lastYear,!1);console.log(todayISO,lastYearISO);var configs=[{model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:[{property:"EndDate",operator:"<=",value:todayISO},{property:"EndDate",operator:">=",value:lastYearISO}],sorters:[{property:"EndDate",direction:"ASC"}]}];async.map(configs,app.wsapiQuery,function(error,results){console.log(_.map(results[0],function(r){return r.get("Project")}));var groupedByProject=_.groupBy(results[0],function(r){return r.get("Project").Name}),teams=_.keys(groupedByProject),teamLastIterations=_.map(_.values(groupedByProject),function(gbp){return _.last(gbp,4)});async.map(teamLastIterations,app.iterationData,function(error,results){app.teamResults=_.map(results,function(result,i){return{team:teams[i],summary:results[i]}}),app.addTable(app.teamResults)})})},iterationData:function(iterations,callback){var configs=_.map(iterations,function(iteration){return{model:"IterationCumulativeFlowData",fetch:["CardEstimateTotal","CardState","CreationDate"],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"IterationObjectID",operator:"=",value:iteration.get("ObjectID")})]}});async.map(configs,app.wsapiQuery,function(error,results){var summaries=[];_.each(results,function(iterationRecords,index){var groupedByDate=_.groupBy(iterationRecords,function(ir){return ir.get("CreationDate")}),iterationDates=_.keys(groupedByDate);iterationDates=_.sortBy(iterationDates,function(d){return Rally.util.DateTime.fromIsoString(d)});var firstDayRecs=groupedByDate[_.first(iterationDates)],lastDayRecs=groupedByDate[_.last(iterationDates)],committed=_.reduce(firstDayRecs,function(memo,val){return memo+(null!==val.get("CardEstimateTotal")?val.get("CardEstimateTotal"):0)},0),accepted=_.reduce(lastDayRecs,function(memo,val){var estimate=val.get("CardEstimateTotal"),done="Accepted"===val.get("CardState")||"Released"===val.get("CardState");return memo+(done&&!_.isNull(estimate))?estimate:0},0);summaries.push({project:iterations[index].get("Project"),iteration:iterations[index].get("Name"),id:iterations[index].get("ObjectID"),committed:committed,accepted:accepted})}),callback(null,summaries)})},addTable:function(teamResults){var grid=Ext.create("Rally.ui.grid.Grid",{store:Ext.create("Rally.data.custom.Store",{data:teamResults}),columnCfgs:[{text:"Team",dataIndex:"team"},{text:"Last Sprint Link",dataIndex:"summary",renderer:app.LinkRenderer},{text:"Last 4 Sprints",dataIndex:"summary",renderer:app.renderSummaries,width:160},{text:"Chart",dataIndex:"summary",renderer:app.renderChart,width:150,align:"center"}]});app.add(grid)},renderChart:function(value,metaData,record,rowIdx,colIdx,store,view){console.log("value",value);var data=_.map(value,function(v,i){var drec={acceptedPercent:v.committed>0?100*(v.accepted/v.committed):0,index:i+1};return drec});record.chartStore=Ext.create("Ext.data.JsonStore",{fields:["index","acceptedPercent"],data:data}),record.chartConfig={width:100,height:100,axes:[{type:"Numeric",position:"left",fields:["acceptedPercent"],label:{renderer:Ext.util.Format.numberRenderer("0,0")},grid:!0,minimum:0,maximum:100},{type:"Category",position:"bottom",fields:["index"]}],series:[{listeners:{itemclick:function(a,b,c){console.log("test",this,a,b,c)}},type:"line",highlight:{size:2,radius:2},axis:"left",xField:"index",yField:"acceptedPercent",markerConfig:{type:"cross",size:2,radius:2,"stroke-width":0}}]};var id=Ext.id();Ext.defer(function(id){record.chartConfig.renderTo=id,record.chartConfig.store=record.chartStore,void 0===record.chart&&(record.chart=Ext.create("Ext.chart.Chart",record.chartConfig))},50,void 0,[id]);var project=value[0].project.ObjectID,iteration=_.last(value).id,href="https://rally1.rallydev.com/#/"+project+"/oiterationstatus?iterationKey="+iteration;return console.log("project",project,"iteration",iteration,"href",href),"<a id='"+id+"' href="+href+" target=_blank></a>"},LinkRenderer:function(value,metaData,record,rowIdx,colIdx,store,view){console.log("value",value,record);var workspace=app.getContext().getProject().ObjectID,lastSprintId=_.last(value).id;return console.log("workspace=",workspace,"lastSid=",lastSprintId),"<a href='https://rally1.rallydev.com/#/"+workspace+"/oiterationstatus?iterationKey="+lastSprintId+"' target='_blank'>Last one</a>"},renderSummaries:function(value,metaData,record,rowIdx,colIdx,store,view){return"<table class='iteration-summary'><tr><td>Committed</td><td>"+value[0].committed+"</td>"+"<td>"+value[1].committed+"</td>"+"<td>"+value[2].committed+"</td>"+"<td>"+value[3].committed+"</td>"+"</tr>"+"<tr>"+"<td>Accepted</td>"+"<td>"+value[0].accepted+"</td>"+"<td>"+value[1].accepted+"</td>"+"<td>"+value[2].accepted+"</td>"+"<td>"+value[3].accepted+"</td>"+"</tr>"+"</table>"},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,sorters:config.sorters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});

            Rally.launchApp('CustomApp', {
                name:"DashB",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .iteration-summary tr td{border:1px solid #427BD6;border-collapse:collapse;padding:3px;text-align:center}.iteration-summary{border:1px solid #427BD6;border-collapse:collapse;padding:3px}
    </style>
</head>
<body>
</body>
</html>
