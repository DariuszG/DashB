<!DOCTYPE html>
<html>
<head>
    <title>DashB</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this,app.queryIterations()},getSettingsFields:function(){var values=[{name:"commitAcceptRatio",xtype:"rallytextfield",label:"Target accepted .v. committed percent"},{name:"continuousImprovementRangeMin",xtype:"rallytextfield",label:"Continuous Improvement Range Min"},{name:"continuousImprovementRangeMax",xtype:"rallytextfield",label:"Continuous Improvement Range Max"}];return values},config:{defaultSettings:{commitAcceptRatio:75,continuousImprovementRangeMin:5,continuousImprovementRangeMax:10}},queryIterations:function(){var today=new Date,lastYear=new Date;lastYear.setDate(today.getDate()-365);var todayISO=Rally.util.DateTime.toIsoString(today,!1),lastYearISO=Rally.util.DateTime.toIsoString(lastYear,!1),configs=[{model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:[{property:"EndDate",operator:"<=",value:todayISO},{property:"EndDate",operator:">=",value:lastYearISO}],sorters:[{property:"EndDate",direction:"ASC"}]}];async.map(configs,app.wsapiQuery,function(error,results){var iterationsRaw=results[0],prjRefs=_.map(results[0],function(iter){return iter.get("Project").ObjectID}),uniqPrjRefs=_.uniq(prjRefs),querConfigs=_.map(uniqPrjRefs,function(p){return{model:"Project",fetch:["TeamMembers"],filters:[{property:"ObjectID",value:p}]}});async.map(querConfigs,app.wsapiQuery,function(err,results){var flatTM=_.flatten(results),flatNotEmptyTM=_.filter(flatTM,function(prj){return prj.get("TeamMembers").Count>0}),uniqPrjIdTM=_.map(flatNotEmptyTM,function(val){return val.get("ObjectID")}),inerNoEmptyTM=_.filter(iterationsRaw,function(iter){return _.contains(uniqPrjIdTM,iter.get("Project").ObjectID)}),groupedByProject=_.groupBy(inerNoEmptyTM,function(r){return r.get("Project").Name}),teams=_.keys(groupedByProject),teamLastIterations=_.map(_.values(groupedByProject),function(gbp){return _.last(gbp,4)});async.map(teamLastIterations,app.teamData,function(error,results){app.teamResults=_.map(results,function(result,i){return{team:teams[i],summary:_.merge(results[i][0],results[i][1],results[i][2])}}),app.addTable(app.teamResults)})})})},teamData:function(iterations,callback){app.iterationsData(iterations,function(x,iterationResults){app.improvementsData(iterations,function(err,improvementResults){app.allIterationItems(iterations,function(err,allIterationItems){callback(null,[iterationResults,improvementResults,allIterationItems])})})})},allIterationItems:function(iterations,callback){var configs=_.map(iterations,function(iteration){return{model:"HierarchicalRequirement",fetch:["ObjectID","PlanEstimate","Name","FormattedID","Project","ScheduleState"],filters:[{property:"Iteration.ObjectID",operator:"=",value:iteration.get("ObjectID")}]}});async.map(configs,app.wsapiQuery,function(error,results){var allData=[];_.each(results,function(allStories){var allIterationData={totalScope:_.reduce(allStories,function(memo,r){return memo+(null!==r.get("PlanEstimate")?r.get("PlanEstimate"):0)},0),lateAccepted:_.reduce(allStories,function(memo,r){return memo+app.acceptedValue(r)},0)};allData.push(allIterationData)}),callback(null,allData)})},improvementsData:function(iterations,callback){var configs=_.map(iterations,function(iteration){return{model:"HierarchicalRequirement",fetch:["ObjectID","PlanEstimate","Name","FormattedID","Project","ScheduleState"],filters:[{property:"Feature.Name",operator:"contains",value:"Continuous Improvement"},{property:"Iteration.ObjectID",operator:"=",value:iteration.get("ObjectID")},{property:"ScheduleState",operator:"=",value:"Accepted"}]}});async.map(configs,app.wsapiQuery,function(error,results){var allData=[];_.each(results,function(result){var improvementRec={totalImprovementPoints:_.reduce(result,function(memo,r){return memo+app.acceptedValue(r)},0)};allData.push(improvementRec)}),callback(null,allData)})},acceptedValue:function(story){var accepted="Accepted"===story.get("ScheduleState")||"Released"==story.get("ScheduleState"),val=accepted&&null!==story.get("PlanEstimate")?story.get("PlanEstimate"):0;return val},iterationsData:function(iterations,callback){var configs=_.map(iterations,function(iteration){return{model:"IterationCumulativeFlowData",fetch:["CardEstimateTotal","CardState","CreationDate"],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"IterationObjectID",operator:"=",value:iteration.get("ObjectID")})]}});async.map(configs,app.wsapiQuery,function(error,results){var summaries=[];_.each(results,function(iterationRecords,index){if(iterationRecords.length>0){var groupedByDate=_.groupBy(iterationRecords,function(ir){return ir.get("CreationDate")}),iterationDates=_.keys(groupedByDate);iterationDates=_.sortBy(iterationDates,function(d){return Rally.util.DateTime.fromIsoString(d)});var firstDayRecs=groupedByDate[_.first(iterationDates)],lastDayRecs=groupedByDate[_.last(iterationDates)];if(firstDayRecs.length>0&&lastDayRecs.length>0){var committed=_.reduce(firstDayRecs,function(memo,val){return memo+(null!==val.get("CardEstimateTotal")?val.get("CardEstimateTotal"):0)},0),accepted=_.reduce(lastDayRecs,function(memo,val){var estimate=val.get("CardEstimateTotal"),done="Accepted"===val.get("CardState")||"Released"===val.get("CardState");return memo+(done&&!_.isNull(estimate))?estimate:0},0);summaries.push({project:iterations[index].get("Project"),iteration:iterations[index].get("Name"),id:firstDayRecs[0].get("IterationObjectID"),committed:Math.round(committed),accepted:Math.round(accepted)})}}}),callback(null,summaries)})},addTable:function(teamResults){var grid=Ext.create("Rally.ui.grid.Grid",{store:Ext.create("Rally.data.custom.Store",{data:teamResults}),columnCfgs:[{text:"Team",dataIndex:"team"},{text:"Last 4 Sprints",dataIndex:"summary",renderer:app.renderSummaries,width:200},{text:"% Accepted Chart",dataIndex:"summary",renderer:app.renderAcceptedChart,width:150,align:"center"},{text:"% Improvement Chart",dataIndex:"summary",renderer:app.renderImprovementChart,width:150,align:"center"}]});app.add(grid)},renderAcceptedChart:function(value,metaData,record,rowIdx,colIdx,store,view){var data=_.map(value,function(v,i){var drec={acceptedPercent:v.committed>0?Math.round(100*(v.accepted/v.committed)):0,targetPercent:app.getSetting("commitAcceptRatio"),index:i+1};return drec});record.chartStore=Ext.create("Ext.data.JsonStore",{fields:["index","acceptedPercent","targetPercent"],data:data}),record.chartConfig={width:100,height:100,axes:[{type:"Numeric",position:"left",fields:["acceptedPercent"],label:{renderer:Ext.util.Format.numberRenderer("0,0")},grid:!0},{type:"Category",position:"bottom",fields:["index"]}],series:[{type:"line",highlight:{size:2,radius:2},axis:"left",xField:"index",yField:"acceptedPercent"},{type:"line",style:{stroke:"#ff0000",fill:"#ff0000"},markerConfig:{type:"circle",size:1,radius:1},axis:"left",xField:"index",yField:"targetPercent"}]};var id=Ext.id();Ext.defer(function(id){record.chartConfig.renderTo=id,record.chartConfig.store=record.chartStore,void 0===record.chart&&(record.chart=Ext.create("Ext.chart.Chart",record.chartConfig))},50,void 0,[id]);var prj=value[0].project.ObjectID,iteration=_.last(value).id,href="https://rally1.rallydev.com/#/"+prj+"/oiterationstatus?iterationKey="+iteration;return"<a id='"+id+"'href="+href+" target=_blank></a>"},renderImprovementChart:function(value,metaData,record,rowIdx,colIdx,store,view){var data=_.map(value,function(v,i){var drec={improvementPercent:v.totalScope>0?Math.round(100*(v.totalImprovementPoints/v.totalScope)):0,index:i+1};return drec});record.improvementChartStore=Ext.create("Ext.data.JsonStore",{fields:["index","improvementPercent"],data:data}),record.improvementChartConfig={width:100,height:100,axes:[{type:"Numeric",position:"left",fields:["improvementPercent"],label:{renderer:Ext.util.Format.numberRenderer("0,0")},grid:!0},{type:"Category",position:"bottom",fields:["index"]}],series:[{type:"line",highlight:{size:2,radius:2},axis:"left",xField:"index",yField:"improvementPercent"}]};var id=Ext.id();return Ext.defer(function(id){record.improvementChartConfig.renderTo=id,record.improvementChartConfig.store=record.improvementChartStore,void 0===record.improvementChart&&(record.improvementChart=Ext.create("Ext.chart.Chart",record.improvementChartConfig))},50,void 0,[id]),"<div id='"+id+"'></div>"},LinkRenderer:function(value,metaData,record,rowIdx,colIdx,store,view){var workspace=app.getContext().getProject().ObjectID,lastSprintId=_.last(value).id;return"<a href='https://rally1.rallydev.com/#/"+workspace+"/oiterationstatus?iterationKey="+lastSprintId+"' target='_blank'>Last one</a>"},renderSummaries:function(value,metaData,record,rowIdx,colIdx,store,view){return"<table class='iteration-summary'><tr><td>Committed</td><td>"+value[0].committed+"</td>"+"<td>"+value[1].committed+"</td>"+"<td>"+value[2].committed+"</td>"+"<td>"+value[3].committed+"</td>"+"</tr>"+"<tr>"+"<td>Accepted</td>"+"<td>"+value[0].accepted+"</td>"+"<td>"+value[1].accepted+"</td>"+"<td>"+value[2].accepted+"</td>"+"<td>"+value[3].accepted+"</td>"+"</tr>"+"</table>"},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,sorters:config.sorters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});

            Rally.launchApp('CustomApp', {
                name:"DashB",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .iteration-summary tr td{border:1px solid #427BD6;border-collapse:collapse;padding:3px;text-align:center}.iteration-summary{height:100px;border:1px solid #427BD6;border-collapse:collapse;padding:10px}
    </style>
</head>
<body>
</body>
</html>
